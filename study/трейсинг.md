Методика мониторинга взаимодействия и производительности сервисов, участвующих в совместной обработке запросов в распределенных системах.
**Суть** - связывание вызовов разных участков кода (спанов) в рамках одного запроса в один *путь* - **трейс**.
***
**OpenTelemetry** - набор соглашений, API, SDK и компонентов для трейсинга. Имеет набор концепций и их реализации на основных языках программирования, позволяющих использовать трейсинг единообразно. Стандарты поддерживаются всеми основными продуктами для организации трейсинга - например, Grafana Tempo.
***
### Основные концепции
##### Trace
Виртуальная сущность, объединяющая в себе путь одного пользовательского запроса. Единого финального объекта не существует (компонентов может быть много) - он динамически собирается в момент поиска в хранилище.
Трейс определяется и формируется из спанов с одинаковым `trace-id` - идентификатором запроса, который генерится в первом спане, которому этот идентификатор не был передан снаружи (с помощью заголовка `traceparent: 00-{trace-id}-{parent-span-id}-00`). Обычно он формируется как можно ближе к источнику запроса, а дальше передается по цепочке вызова.
Одновременно с ним может дополнятся и контекст запроса.
##### Span
Одиночное выполнение участка кода. Содержит:
- контекст - `trace-id`, `span-id` и другие свойства
- родительский спан и его контекст
- `name`
- `start + end time`
- `attributes` - словарь свойств, описывающих текущее событие (аргументы функций, например)
- `events` - дополнительные события, произошедшие во время выполнения кода (`exception`, например)
***
### Instrumentation
Инструментирование - это добавление кода, отвечающего за генерацию трейсов. Помимо добавления кода, необходимо инициализировать общие свойства спанов и настроить отправку спанов в коллектор.
##### Trace Provider и Tracer
**Tracer** - генератор спанов.
**Trace Provider** - это фабрика Tracer, позволяющая создавать экземпляры. Основное предназначение - хранение общей конфигурации, в том числе инициализация общих свойств спанов (*ресурс*) и настройка отправки сгенерированных спанов в коллектор (*exporter*). Обычно создается один раз и изменить настройки после этого уже не получится.
##### Trace Exporter
Его задача - отправить сгенерированные спаны из приложения для дальнейшей обработки и хранения. Чаще всего используются только два:
- `OTLP` - для отправки спанов в коллектор (opentelemetry-collector)
	- либо gRPC (4317)
	- HTTP (4318)
- `Console` - для дебага, спаны пойдут в `stdout`
##### Span Processor
Интерфейс хуков обработки спанов при их создании и завершении. Стандартная задача - упаковать спан в нужный формат и отдать в `Trace Exporter` для отправки в коллектор. Второй частый сценарий - обогащение сформированных спанов дополнительными атрибутами или изменение существующих (например, для обфускации персональных данных).
Регистрируются в TraceProvider и при обработке вызываются в порядке регистрации.
##### Baggage
Key-value хранилище, которое может передаваться вместе с контекстом спана. Основное предназначение - передача дополнительных атрибутов запроса и обогащение спанов этими атрибутами для упрощения поиска и анализа.
Например в него можно положить логин пользователя, и он будет передаваться по всем сервисам, даже если они с ним не взаимодействуют.
В классике передаются вместе с контекстом, но с помощью `BaggageSpanProcessor` можно добавлять в атрибуты спана автоматически.